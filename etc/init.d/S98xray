#!/bin/sh
#
# @file: S98xray
# @brief: Starting/Stopping Xray
#
# @section License
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
# Copyright (C) 2025 for6to9si@gmail.com. All rights reserved.
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.
#
# @author: for6to9si@gmail.com
# @version: 1.0.0

ENABLED=yes
DEBUG=false
export PATH=/opt/bin:/opt/sbin:/usr/bin:/bin:/sbin:/usr/sbin

# –í–∫–ª—é—á–µ–Ω–∏–µ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
#[ "$DEBUG" = "true" ] && set -x

# –í—ã–∫–ª—é—á–µ–Ω–∏–µ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ (–µ—Å–ª–∏ –≤–∫–ª—é—á–∞–ª–∏)
[ "$DEBUG" = "true" ] && set +x


# –ü—É—Ç—å –∫ JSON-—Ñ–∞–π–ª—É —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
if [ ! -f /opt/etc/xwave/settings.json ]; then
    echo "–§–∞–π–ª –Ω–∞—Å—Ç—Ä–æ–µ–∫ /opt/etc/xwave/settings.json –Ω–µ –Ω–∞–π–¥–µ–Ω."
    echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å –ø—Ä–∏–º–µ—Ä–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–∫: /opt/etc/xwave/example.json"
    echo "–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –µ–≥–æ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –≤–∞—à–∏–º–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏,"
    echo "–∑–∞—Ç–µ–º –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ –≤ –Ω—É–∂–Ω–æ–µ –º–µ—Å—Ç–æ –∫–æ–º–∞–Ω–¥–æ–π:"
    echo "  mv /opt/etc/xwave/example.json /opt/etc/xwave/settings.json"
    exit 1
else
    SETTING="/opt/etc/xwave/settings.json"
fi

get_clean_json() {
  awk '
  BEGIN { in_string = 0 }
  {
    line = $0
    result = ""
    for (i = 1; i <= length(line); i++) {
      char = substr(line, i, 1)
      next_char = substr(line, i+1, 1)
      if (char == "\"" && prev != "\\") {
        in_string = !in_string
      }
      if (!in_string && char == "/" && next_char == "/") {
        break
      }
      result = result char
      prev = char
    }
    print result
  }' "$1"
}

# –ü–∞—Ä—Å–∏–Ω–≥ JSON
js_SETTING=$(get_clean_json "$SETTING" | jq -c '.' 2>/dev/null)
if [ $? -ne 0 ] || [ -z "$js_SETTING" ]; then
  echo "–û—à–∏–±–∫–∞: —Ñ–∞–π–ª '$SETTING' —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON." >&2
  exit 1
fi

DEBUG_LOG=$(echo "$js_SETTING" | jq -r '.app.log')

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
debug() {
    [ "$DEBUG" = "true" ] && {
        _YELLOW='\033[33m'
        _NC='\033[0m'  # No Color
        echo -e "${_YELLOW}[DEBUG]${_NC} $*"          # –í—ã–≤–æ–¥ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª
    #    logger -p debug -t "$(basename "$0")" "$*"  # –ò –≤ syslog (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    #    echo "$(date) $*" >> "$DEBUG_LOG"           # –ò –≤ —Ñ–∞–π–ª (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    }
}

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
#chain_name=$(echo "$js_SETTING" | jq -r '.network.chain_name')
#debug "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ü–µ–ø–æ—á–∫–∏ ${chain_name}"


# –¶–≤–µ—Ç–∞
color_green="\033[32m"    # –£—Å–ø–µ—à–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
color_red="\033[31m"      # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏, –æ–ø–∞—Å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
color_yellow="\033[33m"   # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è, –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
color_blue="\033[34m"
color_reset="\033[0m"     # –°–±—Ä–æ—Å —Ü–≤–µ—Ç–∞ –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É

IP_RULES_LOG=$(echo "$js_SETTING" | jq -r '.app.log')

# –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ –∑–∞–¥–∞–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º /dev/null
LOG_FILE="${IP_RULES_LOG:-/dev/null}"

PROCS=$(echo "$js_SETTING" | jq -r '.client.name')
PATH=/opt/sbin:/opt/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
ACTION=$1
CALLER=$2


# –ü—Ä–æ–≤–µ—Ä–∫–∞, –∑–∞–ø—É—â–µ–Ω –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –¥–ª—è –¥–∞–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
is_running() {
    LOCK_FILE=$(echo "$js_SETTING" | jq -r '.client.lockFile // "/opt/tmp/xray-xwave.lock"')
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    if [ -f "$LOCK_FILE" ]; then
        PID=$(cat "$LOCK_FILE" 2>/dev/null)
        if [ -n "$PID" ] && kill -0 "$PID" 2>/dev/null; then
            return 0 # –ü—Ä–æ—Ü–µ—Å—Å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        else
            # –£–¥–∞–ª—è–µ–º —É—Å—Ç–∞—Ä–µ–≤—à–∏–π —Ñ–∞–π–ª –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
            rm -f "$LOCK_FILE"
        fi
    fi
    return 1 # –ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω
}

# –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å PID
create_lock_file() {
    LOCK_FILE=$(echo "$js_SETTING" | jq -r '.client.lockFile // "/opt/tmp/xray-xwave.lock"')
    # –ò–∑–≤–ª–µ–∫–∞–µ–º LOCK_DIR –∏–∑ LOCK_FILE
    LOCK_DIR=$(dirname "$LOCK_FILE")
    pid=$1
    mkdir -p "$LOCK_DIR" || {
        debug "–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é $LOCK_DIR"
        exit 1
    }
    echo "$pid" > "$LOCK_FILE" || {
        debug "–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å PID –≤ $LOCK_FILE"
        exit 1
    }
}

start_xray() {
    LOCK_FILE=$(echo "$js_SETTING" | jq -r '.client.lockFile // "/opt/tmp/xray-xwave.lock"')
    if is_running; then
        PID=$(cat "$LOCK_FILE")
        debug "Xray —É–∂–µ –∑–∞–ø—É—â–µ–Ω –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ X-wave (PID: $PID)"
        exit 1
    fi

    path_data="$(echo "$js_SETTING" | jq -r '.database.path_data // "/opt/etc/xray/dat"' | sed 's:/*$::')"
    path_configs="$(echo "$js_SETTING" | jq -r '.client.path_config // "/opt/etc/xray/dat"' | sed 's:/*$::')"

    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –ª–æ–≥ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º xray
    {
      export XRAY_RAY_BUFFER_SIZE=4
      export XRAY_LOCATION_ASSET="${path_data}"
      export XRAY_LOCATION_CONFDIR="${path_configs}"
      echo -e "\n=== $(date) === xray client info ==="
      xray run
    } >> "${LOG_FILE}" 2>&1 &
    XRAY_PID=$!
    # xray run &

    if ! kill -0 "$XRAY_PID" 2>/dev/null; then
        debug "–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å Xray"
        exit 1
    fi

    create_lock_file "$XRAY_PID"
    debug "–ó–∞–ø—É—Å–∫ Xray —É—Å–ø–µ—à–µ–Ω –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ X-wave (PID: $XRAY_PID)"
}

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Xray
stop_xray() {
    LOCK_FILE=$(echo "$js_SETTING" | jq -r '.client.lockFile // "/opt/tmp/xray-xwave.lock"')
    if ! is_running; then
        debug "Xray –Ω–µ –∑–∞–ø—É—â–µ–Ω –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ X-wave"
        exit 1
    fi

    PID=$(cat "$LOCK_FILE")
    kill "$PID" 2>/dev/null || {
        debug "–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å Xray (PID: $PID)"
        exit 1
    }
    rm -f "$LOCK_FILE"
    debug "Xray –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ X-wave (PID: $PID)"
}


check_iptables_tproxy() {
    TEST_CHAIN=$(echo "$js_SETTING" | jq -r '.network.chain_name // "TPROXY_TEST_CHAIN"')

    # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ü–µ–ø–æ—á–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ mangle
    iptables -t mangle -N "${TEST_CHAIN}" 2>/dev/null

    # –ü—Ä–æ–±—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å TPROXY+SOCKET –ø—Ä–∞–≤–∏–ª–æ
    if iptables -t mangle -A "${TEST_CHAIN}" -p tcp -m socket -j TPROXY --on-port 12345 --tproxy-mark 0x1/0x1 2>/dev/null; then
        debug "[OK] iptables –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç TPROXY –∏ SOCKET"
        iptables -t mangle -F "${TEST_CHAIN}"
        iptables -t mangle -X "${TEST_CHAIN}"
        return 0
    else
        echo "[-] iptables –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç TPROXY –∏/–∏–ª–∏ SOCKET"
        logger -t "$(basename "$0")" "[-] iptables –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç TPROXY –∏/–∏–ª–∏ SOCKET"
        iptables -t mangle -F "${TEST_CHAIN}" 2>/dev/null
        iptables -t mangle -X "${TEST_CHAIN}" 2>/dev/null
        return 1
    fi
}

check_iptables_multiport() {
    TEST_CHAIN=$(echo "$js_SETTING" | jq -r '.network.chain_name // "TPROXY_TEST_CHAIN"')
    iptables -t mangle -N "${TEST_CHAIN}" 2>/dev/null
    if iptables -t mangle -A "${TEST_CHAIN}" -p tcp -m multiport --dports 180,2443,2080 -j RETURN 2>/dev/null; then
        debug "[OK] iptables –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç multiport"
        iptables -t mangle -F "${TEST_CHAIN}"
        iptables -t mangle -X "${TEST_CHAIN}"
    else
        echo "[-] iptables –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç multiport"
        logger -t "$(basename "$0")" "[-] iptables –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç multiport"
        iptables -t mangle -F "${TEST_CHAIN}" 2>/dev/null
        iptables -t mangle -X "${TEST_CHAIN}" 2>/dev/null
        exit 1
    fi
}

get_policy_mark() {

  # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–¥—ã —Ü–≤–µ—Ç–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ–º $'...' –¥–ª—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ escape-–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π)
  _color_red=$'\033[31m'
  _color_reset=$'\033[0m'

  policy_mark=$(
      curl -kfsS "localhost:79/rci/show/ip/policy" \
      | jq -r --arg policy "$(echo "$js_SETTING" | jq -r '.network.connection_policy')" '
          .[]
          | select(.description
          | ascii_downcase == ($policy | ascii_downcase))
          | .mark'
  )

  if [ -z "$policy_mark" ]; then
      printf "%s %s[ERROR]%s –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–º–µ—Ç–∫—É –æ –ø–æ–ª–∏—Ç–∏–∫–µ –¥–ª—è: %s\n" \
        "$(date '+%Y-%m-%d %H:%M:%S')" \
        "$_color_red" \
        "$_color_reset" \
        "$(echo "$js_SETTING" | jq -r '.network.connection_policy')" >&2
      logger -t "$(basename "$0")" "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–º–µ—Ç–∫—É –æ –ø–æ–ª–∏—Ç–∏–∫–µ –¥–ª—è: $(echo "$js_SETTING" | jq -r '.network.connection_policy')"
      return 1
  fi

  echo "0x${policy_mark}"
}

wait_for_iptables_tables() {
    TIMEOUT="${1:-20}"
    INTERVAL=1
    ELAPSED=0
    client=$(echo "$js_SETTING" | jq -r '.client.name')
    policy=$(echo "$js_SETTING" | jq -r '.network.connection_policy')
    logger -t "$(basename "$0")" "[${client}] –û–∂–∏–¥–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ iptables (—Ç–∞–±–ª–∏—Ü—ã nat –∏ mangle)..."

    while :; do
        NAT_READY=false
        MANGLE_READY=false
        MULTIPORT_READY=false

        iptables -t nat -S >/dev/null 2>&1 && NAT_READY=true
        iptables -t mangle -S >/dev/null 2>&1 && MANGLE_READY=true

        if $NAT_READY && $MANGLE_READY; then
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ multiport ‚Äî —Å–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ü–µ–ø–æ—á–∫—É –æ–¥–∏–Ω —Ä–∞–∑
            TMP_CHAIN="MULTIPORT_TEST_CHAIN"
            iptables -t mangle -N $TMP_CHAIN 2>/dev/null

            if iptables -t mangle -A $TMP_CHAIN -p tcp -m multiport --dports 881,2443 -j RETURN 2>/dev/null; then
                MULTIPORT_READY=true
                iptables -t mangle -F $TMP_CHAIN
                iptables -t mangle -X $TMP_CHAIN
            else
                iptables -t mangle -F $TMP_CHAIN 2>/dev/null
                iptables -t mangle -X $TMP_CHAIN 2>/dev/null
            fi
        fi

        if $NAT_READY && $MANGLE_READY && $MULTIPORT_READY; then
            logger -t "$(basename "$0")" "[${client}] iptables: nat, mangle –∏ multiport –¥–æ—Å—Ç—É–ø–Ω—ã"
            if ip rule show | grep -q "fwmark $(get_policy_mark)"; then
              logger -t "$(basename "$0")" "[${client}] —Ç—Ä–µ–±—É–µ–º–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞ ${policy} –Ω–∞ —Ä–æ—É—Ç–µ—Ä–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞"
              return 0
            fi
        fi

        sleep "$INTERVAL"
        ELAPSED=$((ELAPSED + INTERVAL))
        if [ "$ELAPSED" -ge "$TIMEOUT" ]; then
            logger -t "$(basename "$0")" "[${client}] iptables –Ω–µ –≥–æ—Ç–æ–≤—ã (nat, mangle, multiport) –∑–∞ $TIMEOUT —Å–µ–∫"
            return 1
        fi
    done
}


init_ip_rules() {

  ip_version="${1}"
  table_mark_hex=$(echo "$js_SETTING" | jq -r '.network.table_mark_hex')
  table_id=$(echo "$js_SETTING" | jq -r '.network.table_id')

  # –ü—Ä–æ–≤–µ—Ä–∫–∞, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø—Ä–∞–≤–∏–ª–æ
  if ! busybox ip -"${ip_version}" rule show | grep -q "fwmark ${table_mark_hex} lookup ${table_id}" >/dev/null 2>&1; then

    # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∏–ª–æ –∏ —Ç–∞–±–ª–∏—Ü—É –º–∞—Ä—à—Ä—É—Ç–æ–≤
    busybox ip -"${ip_version}" rule add fwmark "${table_mark_hex}" lookup "${table_id}" >/dev/null 2>&1
    busybox ip -"${ip_version}" route add local default dev lo table "${table_id}" >/dev/null 2>&1

    appname=$(echo "$js_SETTING" | jq -r '.app.name')
    # shellcheck disable=SC3037
    debug "$(date '+%Y-%m-%d %H:%M:%S') ${color_green}[SUCCESS]${color_reset} –ú–∞—Ä—à—Ä—É—Ç ${appname} –¥–ª—è IPv${ip_version} —É—Å–ø–µ—à–Ω–∞ —Å–æ–∑–¥–∞–Ω–∞" >&2
  fi
}

del_iptables() {

  chain_name="${1}"
  for family in iptables ip6tables; do
    for table in nat mangle; do
      debug "[*] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü—ã '$table' (${family})"
      if $family -t "$table" -S 2>/dev/null | grep -qP "^-N ${chain_name}\b"; then
        debug "[+] –û—á–∏—Å—Ç–∫–∞ —Ü–µ–ø–æ—á–∫–∏ '${chain_name}' –≤ —Ç–∞–±–ª–∏—Ü–µ '$table' (${family})"
        $family -t "$table" -F "${chain_name}"

        debug "[+] –£–¥–∞–ª–µ–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –≤ —Ü–µ–ø–æ—á–∫—É '${chain_name}' –≤ —Ç–∞–±–ª–∏—Ü–µ '$table' (${family})"
        while $family -t "$table" -S 2>/dev/null | grep -P "^-A .+ -j ${chain_name}\b" >/dev/null; do
          local rule=$($family -t "$table" -S 2>/dev/null | grep -P "^-A .+ -j ${chain_name}\b" | head -n 1)
          eval $family -t "$table" ${rule/-A/-D}
        done

        debug "[+] –£–¥–∞–ª–µ–Ω–∏–µ —Ü–µ–ø–æ—á–∫–∏ '${chain_name}' –≤ —Ç–∞–±–ª–∏—Ü–µ '$table' (${family})"
        $family -t "$table" -X "${chain_name}"
      else
        debug "[!] –¶–µ–ø–æ—á–∫–∞ '${chain_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –≤ —Ç–∞–±–ª–∏—Ü–µ '$table' (${family})"
      fi
    done
  done
}

del_ip_rules() {

  ip_version="${1}"

  table_mark_hex=$(echo "$js_SETTING" | jq -r '.network.table_mark_hex')
  table_id=$(echo "$js_SETTING" | jq -r '.network.table_id')


  if busybox ip -"${ip_version}" rule show | grep -q "fwmark ${table_mark_hex} lookup ${table_id}" >/dev/null 2>&1; then
    busybox ip -"${ip_version}" rule del fwmark ${table_mark_hex} lookup ${table_id} >/dev/null 2>&1
    busybox ip -"${ip_version}" route flush table ${table_id} >/dev/null 2>&1
    appname=$(echo "$js_SETTING" | jq -r '.app.name')
    # shellcheck disable=SC3037
    debug "$(date '+%Y-%m-%d %H:%M:%S') ${color_green}[SUCCESS]${color_reset} –¢–∞–±–ª–∏—Ü–∞ IPv${ip_version} –º–∞—Ä—à—Ä—É—Ç–∞ –¥–ª—è ${appname} —É—Å–ø–µ—à–Ω–∞ —É–¥–∞–ª–µ–Ω–∞" >&2
  fi
}

backup_config_xray() {

    SOURCE_DIR="$(echo "$js_SETTING" | jq -r '.client.path_config')"
    BACKUP_BASE_DIR="/opt/backups/xray"
    TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
    BACKUP_DIR="${BACKUP_BASE_DIR}/${TIMESTAMP}"
    SETTINGS_FILE="/opt/etc/xwave/settings.json"
    SETTINGS_BACKUP_DIR="${BACKUP_DIR}/xwave"
    ARCHIVE_FILE="${BACKUP_BASE_DIR}/xray-backup-${TIMESTAMP}.tar.gz"

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –±–∞–∑–æ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    if [ ! -d "$BACKUP_BASE_DIR" ]; then
        echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è $BACKUP_BASE_DIR –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
        echo -n "–•–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å –µ—ë? (y/n): "
        read answer
        if [ "$answer" = "y" ] || [ "$answer" = "Y" ]; then
            mkdir -p "$BACKUP_BASE_DIR" || {
                echo "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é $BACKUP_BASE_DIR"
                return 1
            }
            echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞: $BACKUP_BASE_DIR"
        else
            echo "–û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º."
            return 1
        fi
    fi

    # –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É –¥–ª—è –Ω–æ–≤–æ–≥–æ –±—ç–∫–∞–ø–∞
    mkdir -p "$BACKUP_DIR"

    # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ sing-box
    if [ -d "$SOURCE_DIR" ]; then
        cp -r "$SOURCE_DIR/"* "$BACKUP_DIR/" 2>/dev/null
        echo "–§–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ $SOURCE_DIR —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã."
    else
        echo "–ò—Å—Ç–æ—á–Ω–∏–∫ $SOURCE_DIR –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–ø—É—Å–∫ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ sing-box."
    fi

    # –°–æ–∑–¥–∞—ë–º –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ swave
    mkdir -p "$SETTINGS_BACKUP_DIR"

    # –ö–æ–ø–∏—Ä—É–µ–º settings.json –æ—Ç–¥–µ–ª—å–Ω–æ
    if [ -f "$SETTINGS_FILE" ]; then
        cp "$SETTINGS_FILE" "$SETTINGS_BACKUP_DIR/" || echo "–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è $SETTINGS_FILE"
        echo "–§–∞–π–ª $SETTINGS_FILE —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ $SETTINGS_BACKUP_DIR"
    else
        echo "–§–∞–π–ª $SETTINGS_FILE –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–ø—É—Å–∫."
    fi

    # –ê—Ä—Ö–∏–≤–∞—Ü–∏—è –≤—Å–µ–≥–æ –±—ç–∫–∞–ø–∞
    tar -czf "$ARCHIVE_FILE" -C "$BACKUP_BASE_DIR" "$TIMESTAMP" && echo "–ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω: $ARCHIVE_FILE"

    # –ú–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É –ø–æ—Å–ª–µ –∞—Ä—Ö–∏–≤–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–∞)
    rm -rf "$BACKUP_DIR"

    echo "–ë—ç–∫–∞–ø —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω."
}

IPv6=$(echo "$js_SETTING" | jq -r '.network.IPv6 // "false"')

if ip -6 addr show scope global | grep -q inet6; then
    debug "IPv6-–∞–¥—Ä–µ—Å–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ)"
else
    debug "IPv6-–∞–¥—Ä–µ—Å–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∏–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã"
    IPv6=false
fi

kernel_modules_load() {
    KERNEL=$(uname -r)

    for mod in xt_TPROXY xt_socket xt_multiport; do
        debug "[INFO] Checking for module: $mod"

        if lsmod | grep -q "^$mod"; then
            debug "[OK] $mod already loaded"
            continue
        fi

        mod_file=$(find /lib/modules/"$KERNEL" -name "$mod.ko*" 2>/dev/null | head -n1)

        if [ -n "$mod_file" ]; then
            logger -t "$(basename "$0")" "[INFO] Found $mod at $mod_file"
            if insmod "$mod_file" 2>/dev/null; then
                logger -t "$(basename "$0")" "[OK] $mod loaded via insmod"
                continue
            else
                logger -t "$(basename "$0")" "[WARN] insmod failed for $mod"
            fi
        else
            logger -t "$(basename "$0")" "[WARN] No .ko file found for $mod"
        fi

        if modprobe "$mod" --first-time 2>/dev/null; then
            logger -t "$(basename "$0")" "[OK] $mod loaded via modprobe"
        else
            if lsmod | grep -q "^$mod"; then
                logger -t "$(basename "$0")" "[OK] $mod is already loaded (modprobe failed because of that)"
            else
                logger -t "$(basename "$0")" "[FAIL] Failed to load $mod"
            fi
        fi
    done

}

init_exclusions_ip(){

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ü–µ–ø–æ—á–µ–∫ –∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ dns_filter
    if [ "${1}" = "iptables" ] \
    && [ "${2}" = "nat" ] \
    && iptables -t nat -nL "${3}" >/dev/null 2>&1
    then
        # IPv4
        for ip in $(echo "$js_SETTING" | jq -r '.network.IPv4_exclusions[]'); do
            if ! iptables -t nat -C "${3}" -d "$ip" -j RETURN 2>/dev/null; then
              iptables -w -t nat -A "${3}" -d "$ip"  -j RETURN
              debug "[OK] IP ${ip} –∏–∑ IPv4_exclusions –±—ã–ª –≤–Ω–µ—Å–µ–Ω –≤ (—Ç–∞–±–ª–∏—Ü–∞: ${2}) —Ü–µ–ø–∏ ${3}"
            else
              debug "[FAIL] IP ${ip} –∏–∑ IPv4_exclusions –±—ã–ª –≤–Ω–µ—Å–µ–Ω –≤ (—Ç–∞–±–ª–∏—Ü–∞: ${2}) —Ü–µ–ø–∏ ${3}"
            fi
        done
    fi

    if [ "${1}" = "iptables" ] \
    && [ "${2}" = "mangle" ] \
    && iptables -t mangle -nL "${3}" >/dev/null 2>&1
    then
        # IPv4
        for ip in $(echo "$js_SETTING" | jq -r '.network.IPv4_exclusions[]'); do
            if ! iptables -t mangle -C "${3}" -d "$ip" -j RETURN 2>/dev/null; then
              iptables -w -t mangle -A "${3}" -d "$ip" -j RETURN
              debug "[OK] IP ${ip} –∏–∑ IPv4_exclusions –±—ã–ª –≤–Ω–µ—Å–µ–Ω –≤ (—Ç–∞–±–ª–∏—Ü–∞: ${2}) —Ü–µ–ø–∏ ${3}"
            else
              debug "[FAIL] IP ${ip} –∏–∑ IPv4_exclusions –±—ã–ª –≤–Ω–µ—Å–µ–Ω –≤ (—Ç–∞–±–ª–∏—Ü–∞: ${2}) —Ü–µ–ø–∏ ${3}"
            fi
        done
    fi

    if [ "${1}" = "ip6tables" ] \
    && [ "${2}" = "nat" ] \
    && ip6tables -t nat -nL "${3}" >/dev/null 2>&1
    then
        # –ü—Ä–æ–≤–µ—Ä–∫–∞, —Ä–∞–∑—Ä–µ—à—ë–Ω –ª–∏ IPv6

        if [ "$IPv6" != "false" ]; then
            for ip6 in $(echo "$js_SETTING" | jq -r '.network.IPv6_exclusions[]'); do
                if ! ip6tables -t nat -C "${3}" -d "$ip6" -j RETURN 2>/dev/null; then
                  ip6tables -w -t nat    -A "${3}" -d "$ip6" -j RETURN
                  debug "[OK] IP ${ip6} –∏–∑ IPv6_exclusions –±—ã–ª –≤–Ω–µ—Å–µ–Ω –≤ (—Ç–∞–±–ª–∏—Ü–∞: ${2}) —Ü–µ–ø–∏ ${3}"
                else
                  debug "[FAIL] IP ${ip6} –∏–∑ IPv6_exclusions –±—ã–ª –≤–Ω–µ—Å–µ–Ω –≤ (—Ç–∞–±–ª–∏—Ü–∞: ${2}) —Ü–µ–ø–∏ ${3}"
                fi
            done
        fi
    fi

    if [ "${1}" = "ip6tables" ] \
    && [ "${2}" = "mangle" ] \
    && ip6tables -t mangle -nL "${3}" >/dev/null 2>&1
    then
        # –ü—Ä–æ–≤–µ—Ä–∫–∞, —Ä–∞–∑—Ä–µ—à—ë–Ω –ª–∏ IPv6

        if [ "$IPv6" != "false" ]; then
            for ip6 in $(echo "$js_SETTING" | jq -r '.network.IPv6_exclusions[]'); do
                if ! ip6tables -t mangle -C "${3}" -d "$ip6" -j RETURN 2>/dev/null; then
                  ip6tables -w -t mangle -A "${3}" -d "$ip6" -j RETURN
                  debug "[OK] IP ${ip6} –∏–∑ IPv6_exclusions –±—ã–ª –≤–Ω–µ—Å–µ–Ω –≤ (—Ç–∞–±–ª–∏—Ü–∞: ${2}) —Ü–µ–ø–∏ ${3}"
                else
                  debug "[FAIL] IP ${ip6} –∏–∑ IPv6_exclusions –±—ã–ª –≤–Ω–µ—Å–µ–Ω –≤ (—Ç–∞–±–ª–∏—Ü–∞: ${2}) —Ü–µ–ø–∏ ${3}"
                fi
            done
        fi
    fi

}

init_tables_nat(){
    family="${1}"
    chain_name=$(echo "$js_SETTING" | jq -r '.network.chain_name')
    chain_name_output="${chain_name}"_out
    table_mark_hex=$(echo "$js_SETTING" | jq -r '.network.table_mark_hex')
    port_tproxy=$(echo "$js_SETTING" | jq -r '.network.port_tproxy')
    port_redirect=$(echo "$js_SETTING" | jq -r '.network.port_redirect')
    policy_mark=$(get_policy_mark)
    port_list=$(echo "$js_SETTING" | jq -r '.network.port_forwarding_list | join(",")')
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç
    if [ -z "$port_list" ]; then
    echo "–û—à–∏–±–∫–∞: –ù–µ—Ç –ø–æ—Ä—Ç–æ–≤ –≤ port_forwarding_list!" >&2
    exit 1
    fi
    if echo "$js_SETTING" | jq -e '.network.dns_filter // false' > /dev/null; then
    port_list="53,${port_list}"
    fi
    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –¥–æ—Å—Ç–∞—ë–º –¥–∏–∞–ø–∞–∑–æ–Ω—ã –ø–æ—Ä—Ç–æ–≤ –∏–ª–∏ –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
    port_ranges=$(echo "$js_SETTING" | jq -r '.network.port_forwarding_range // [] | .[]')

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º ::1 –¥–ª—è ip6tables, –∏–Ω–∞—á–µ 127.0.0.1
    loopback_ip="127.0.0.1"
    [ "$family" = "ip6tables" ] && loopback_ip="::1"
        # PREROUTING
    if ! "${family}" -t nat -nL ${chain_name} >/dev/null 2>&1; then
      "${family}" -w -t nat -N ${chain_name} >> "${LOG_FILE}" 2>&1
      debug "#PREROUTING NAT ($family)"
      "${family}" -w -t nat -A PREROUTING -m connmark --mark ${policy_mark} -m conntrack ! --ctstate INVALID -p tcp -m multiport --dports  ${port_list} -j ${chain_name} >>"${LOG_FILE}" 2>&1
      #"${family}" -w -t nat -A PREROUTING -m connmark --mark ${policy_mark} -m conntrack ! --ctstate INVALID -p tcp -m multiport --dport  53 -j REDIRECT --to-port 5345 >>"${LOG_FILE}" 2>&1
      #"${family}" -w -t nat -A PREROUTING -m connmark --mark ${policy_mark} -m conntrack ! --ctstate INVALID -p udp -m multiport --dport  53 -j REDIRECT --to-port 5345 >>"${LOG_FILE}" 2>&1
      #"${family}" -w -t nat -A OUTPUT -p tcp -m connmark --mark ${policy_mark} -m conntrack ! --ctstate INVALID -m multiport --dport 53 -j REDIRECT --to-ports 5345 >>"${LOG_FILE}" 2>&1
      #"${family}" -w -t nat -A OUTPUT -p udp -m connmark --mark ${policy_mark} -m conntrack ! --ctstate INVALID -m multiport --dport 53 -j REDIRECT --to-ports 5345 >>"${LOG_FILE}" 2>&1

      echo "$port_ranges" | while read -r range; do
        [ -n "$range" ] || continue
        "${family}" -w -t nat -A PREROUTING -m connmark --mark ${policy_mark} -m conntrack ! --ctstate INVALID -p tcp --dport "$range" -j ${chain_name}
      done
        #DNS
      init_exclusions_ip "$family" "nat" "${chain_name}"
      debug "#PREROUTING NAT ($family)"

      [ "$family" = "iptables" ] && add_ipv4tables_exclusions "${chain_name}" "nat"
      [ "$family" = "ip6tables" ] && add_ipv6tables_exclusions "${chain_name}" "nat"

      debug "#REDIRECT ($family)"
      "${family}" -w -t nat -A ${chain_name} -p tcp -j REDIRECT --to-port "${port_redirect}" >> "${LOG_FILE}" 2>&1
    fi
}


#—Å–æ–∑–¥–∞–Ω–∏—è —Ü–µ–ø–∏ –∏ –ø—Ä–∞–≤–∏–ª
init_tables_mangle(){

    family="${1}"
    chain_name=$(echo "$js_SETTING" | jq -r '.network.chain_name')
    chain_name_output="${chain_name}"_out
    table_mark_hex=$(echo "$js_SETTING" | jq -r '.network.table_mark_hex')
    port_tproxy=$(echo "$js_SETTING" | jq -r '.network.port_tproxy')
    port_redirect=$(echo "$js_SETTING" | jq -r '.network.port_redirect')
    policy_mark=$(get_policy_mark)
    port_list=$(echo "$js_SETTING" | jq -r '.network.port_forwarding_list | join(",")')
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç
    if [ -z "$port_list" ]; then
    echo "–û—à–∏–±–∫–∞: –ù–µ—Ç –ø–æ—Ä—Ç–æ–≤ –≤ port_forwarding_list!" >&2
    exit 1
    fi
    if echo "$js_SETTING" | jq -e '.network.dns_filter // false' > /dev/null; then
    port_list="53,${port_list}"
    fi
    # –ë–µ–∑–æ–ø–∞—Å–Ω–æ –¥–æ—Å—Ç–∞—ë–º –¥–∏–∞–ø–∞–∑–æ–Ω—ã –ø–æ—Ä—Ç–æ–≤ –∏–ª–∏ –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
    port_ranges=$(echo "$js_SETTING" | jq -r '.network.port_forwarding_range // [] | .[]')

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º ::1 –¥–ª—è ip6tables, –∏–Ω–∞—á–µ 127.0.0.1
    loopback_ip="127.0.0.1"
    [ "$family" = "ip6tables" ] && loopback_ip="::1"

    # TPROXY
    if ! "${family}" -t mangle -nL ${chain_name} >/dev/null 2>&1; then
      "${family}" -w -t mangle -N ${chain_name}
      debug "#PREROUTING MANGLE ($family)"
      "${family}" -w -t mangle -A PREROUTING -m connmark --mark ${policy_mark} -m conntrack ! --ctstate INVALID -p udp -m multiport --dports  ${port_list} -j ${chain_name} >> "${LOG_FILE}" 2>&1
      #"${family}" -w -t mangle -A PREROUTING -m connmark ! --mark ${policy_mark} -m conntrack ! --ctstate INVALID -p udp -m multiport --dports 53 -j ${chain_name} >> "${LOG_FILE}" 2>&1
      echo "$port_ranges" | while read -r range; do
        [ -n "$range" ] || continue
        "${family}" -w -t mangle -A PREROUTING -m connmark --mark ${policy_mark} -m conntrack ! --ctstate INVALID -p udp --dport "$range" -j ${chain_name}
      done

      #Exclusions_IP
      init_exclusions_ip "$family" "mangle" "${chain_name}"

      [ "$family" = "iptables" ] && add_ipv4tables_exclusions "${chain_name}" "mangle"
      [ "$family" = "ip6tables" ] && add_ipv6tables_exclusions "${chain_name}" "mangle"

      debug "#TPROXY ($family)"
      "${family}" -w -t mangle -A ${chain_name} -p udp -m socket --transparent -j MARK --set-mark "${table_mark_hex}" >> "${LOG_FILE}" 2>&1
      "${family}" -w -t mangle -A ${chain_name} -p udp -j TPROXY --on-ip "$loopback_ip" --on-port "${port_tproxy}" --tproxy-mark "${table_mark_hex}" >> "${LOG_FILE}" 2>&1
    fi

    # OUTPUT mangle
    if ! "${family}" -t mangle -nL ${chain_name_output} >/dev/null 2>&1; then
      "${family}" -w -t mangle -N ${chain_name_output}
      debug "#OUTPUT mangle ($family)"
      init_exclusions_ip "$family" "mangle" "${chain_name_output}"
      [ "$family" = "iptables" ] && add_ipv4tables_exclusions "${chain_name_output}" "mangle"
      [ "$family" = "ip6tables" ] && add_ipv6tables_exclusions "${chain_name_output}" "mangle"
      # ! --uid-owner 0 ‚Äî –ø—Ä–∞–≤–∏–ª–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º, –∫—Ä–æ–º–µ root (UID 0).
      # –î–ª—è –≤—Å–µ—Ö –∏—Å—Ö–æ–¥—è—â–∏—Ö UDP-–ø–∞–∫–µ—Ç–æ–≤, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –ù–ï –æ—Ç root-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ø–µ—Ä–µ—Ö–æ–¥ –≤ —Ü–µ–ø–æ—á–∫—É xwave_out (–∏–¥—ë—Ç –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∞, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∏ —Ç.–¥.).
      #"${family}" -w -t mangle -A OUTPUT -m owner ! --uid-owner 0 -m conntrack ! --ctstate INVALID -p udp -j ${chain_name_output}
      "${family}" -w -t mangle -A OUTPUT -p udp -m multiport --dports  ${port_list} -m conntrack ! --ctstate INVALID -j ${chain_name_output}
      "${family}" -w -t mangle -A ${chain_name_output} -p udp -j CONNMARK --set-mark "${table_mark_hex}"
      echo "$port_ranges" | while read -r range; do
        [ -n "$range" ] || continue
        "${family}" -w -t mangle -A OUTPUT -p udp --dport "$range" -m conntrack ! --ctstate INVALID -j ${chain_name_output}
      done
    fi
}

# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ  —Ü–µ–ø–æ—á–∫–∏ .network.chain_name  –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö mangle –∏ nat –¥–ª—è IPv4.
# –ï—Å–ª–∏ —Ü–µ–ø–æ—á–∫–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –æ–¥–Ω–æ–π –∏–∑ —Ç–∞–±–ª–∏—Ü, –≤—ã–≤–æ–¥–∏—Ç –æ—à–∏–±–∫—É –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 1.
# –í –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 0.
check_chain_ipv4() {
    if ! iptables -t "${2}" -nL "${1}" > /dev/null 2>&1; then
        debug "–û—à–∏–±–∫–∞: –¶–µ–ø–æ—á–∫–∞ ${1} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ $table. –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –µ—ë." >&2
        return 1
    fi
    return 0
}

# –ü–æ–ª—É—á–∏—Ç—å IPv4
get_exclude_ip4() {

    ipv4_eth=$(ip route get 9.9.9.9 | awk '{for(i=1;i<=NF;i++) if($i=="src") print $(i+1)}' ||
    ip route get 1.1.1.1 | awk '{for(i=1;i<=NF;i++) if($i=="src") print $(i+1)}' ||
    ip route get 8.8.8.8 | awk '{for(i=1;i<=NF;i++) if($i=="src") print $(i+1)}'
    )

    [ -n "$ipv4_eth" ] && ipv4_eth="${ipv4_eth}/32 "

    ipv4_exclude=$(echo "$js_SETTING" | jq -r '.network.IPv4_exclusions | join("\n")')
    ipv4_my="$ipv4_eth
            # –î–æ–±–∞–≤–ª—è–µ–º –∞–¥—Ä–µ—Å–∞ —Å–≤–æ–∏—Ö VPN –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            $ipv4_exclude"
    echo "$ipv4_my"

}

add_ipv4tables_exclusions() {

    return 0

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ü–µ–ø–æ—á–∫–∏ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã
    if ! check_chain_ipv4 "${1}" "${2}"; then
        exit 1
    fi

    # –°–ø–∏—Å–æ–∫ IPv4-–∞–¥—Ä–µ—Å–æ–≤ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ (—Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
    ipv4_list="
        # 1. –õ–æ–∫–∞–ª—å–Ω—ã–µ –∞–¥—Ä–µ—Å–∞ (RFC 1918 + —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ)
        10.0.0.0/8              # –ß–∞—Å—Ç–Ω–∞—è —Å–µ—Ç—å (LAN)
        172.16.0.0/12           # –ß–∞—Å—Ç–Ω–∞—è —Å–µ—Ç—å (LAN)
        192.168.0.0/16          # –ß–∞—Å—Ç–Ω–∞—è —Å–µ—Ç—å (LAN)
        100.64.0.0/10           # CGNAT (ISP-level NAT)

        # 2. –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∞–¥—Ä–µ—Å–∞
        0.0.0.0/8               # –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏ '—ç—Ç–æ—Ç —Ö–æ—Å—Ç'
        127.0.0.0/8             # Loopback (localhost)
        169.254.0.0/16          # Link-local (–∞–≤—Ç–æ–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–µ–∑ DHCP)
        255.255.255.255/32      # –®–∏—Ä–æ–∫–æ–≤–µ—â–∞—Ç–µ–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å

        # 3. –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ IANA (–Ω–µ –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
        192.0.0.0/24            # IANA Special Purpose
        192.0.2.0/24            # TEST-NET-1 (–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è)
        198.51.100.0/24         # TEST-NET-2 (–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è)
        203.0.113.0/24          # TEST-NET-3 (–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è)
        198.18.0.0/15           # Benchmarking (—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)

        # 4. Multicast –∏ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –±—É–¥—É—â–µ–µ
        224.0.0.0/4             # Multicast (–≥—Ä—É–ø–ø–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞)
        240.0.0.0/4             # –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –±—É–¥—É—â–µ–≥–æ
    "

    # –§–∏–ª—å—Ç—Ä: —É–¥–∞–ª—è–µ–º –≤—Å—ë, —á—Ç–æ –ø–æ—Å–ª–µ '#', –∑–∞—Ç–µ–º –æ–±—Ä–µ–∑–∞–µ–º –ø—Ä–æ–±–µ–ª—ã
    echo "$ipv4_list" | while read -r line; do
        # –£–¥–∞–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
        # sed -e 's/^[[:space:]]*//' –æ–±—Ä–µ–∑–∞–µ—Ç –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ,
        # sed -e 's/[[:space:]]*$//' ‚Äî –≤ –∫–æ–Ω—Ü–µ —Å—Ç—Ä–æ–∫–∏
        ip=$(echo "$line" | sed -e 's/#.*//' -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
        [ -z "$ip" ] && continue  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏

        if [ "${2}" = "mangle" ] \
        && echo "$js_SETTING" | jq -e '.network.dns_filter // false' > /dev/null
        then
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø—Ä–∞–≤–∏–ª–æ —É–∂–µ
          if ! iptables -w -t "${2}" -C "${1}" -d "$ip" -p udp -m udp ! --dport 53  -j RETURN >/dev/null 2>&1; then
              iptables -w -t "${2}" -A "${1}" -d "$ip" -p udp -m udp ! --dport 53  -j RETURN >> "${LOG_FILE}" 2>&1
              debug "[OK] –î–æ–±–∞–≤–ª–µ–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ: $ip (—Ç–∞–±–ª–∏—Ü–∞: $2)"
          else
              debug "[–ü—Ä–æ–ø—É—Å–∫] –ü—Ä–∞–≤–∏–ª–æ –¥–ª—è $ip —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ $2"
          fi
        else
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø—Ä–∞–≤–∏–ª–æ —É–∂–µ
          if ! iptables -w -t "${2}" -C "${1}" -d "$ip" -j RETURN >/dev/null 2>&1; then
              iptables -w -t "${2}" -A "${1}" -d "$ip" -j RETURN >> "${LOG_FILE}" 2>&1
              debug "[OK] –î–æ–±–∞–≤–ª–µ–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ: $ip (—Ç–∞–±–ª–∏—Ü–∞: $2)"
          else
              debug "[–ü—Ä–æ–ø—É—Å–∫] –ü—Ä–∞–≤–∏–ª–æ –¥–ª—è $ip —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ $2"
          fi
        fi
    done
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ü–µ–ø–æ—á–∫–∞ .network.chain_name –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö mangle –∏ nat
check_chain_ipv6() {

    if ! ip6tables -w -t "${2}" -nL "${1}" >/dev/null 2>&1; then
        debug "–û—à–∏–±–∫–∞: –¶–µ–ø–æ—á–∫–∞ ${1} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ $table. –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –µ—ë." >&2
        return 1
    fi
    return 0
}

# –ü–æ–ª—É—á–∏—Ç—å IPv4
get_exclude_ip6() {

    ipv6_eth=$(ip route get 2620:fe::fe | awk '{for(i=1;i<=NF;i++) if($i=="src") print $(i+1)}' ||
    ip route get 2606:4700:4700::64 | awk '{for(i=1;i<=NF;i++) if($i=="src") print $(i+1)}' ||
    ip route get 2001:4860:4860::8888 | awk '{for(i=1;i<=NF;i++) if($i=="src") print $(i+1)}'
    )

    [ -n "$ipv6_eth" ] && ipv6_eth="${ipv6_eth}/128 "

    ipv6_exclude=$(echo "$js_SETTING" | jq -r '.network.IPv6_exclusions | join("\n")')
    ipv6_my="$ipv6_eth
            # –î–æ–±–∞–≤–ª—è–µ–º –∞–¥—Ä–µ—Å–∞ —Å–≤–æ–∏—Ö VPN –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
            $ipv6_exclude"
    echo "$ipv6_my"

}

add_ipv6tables_exclusions() {

    return 0

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ü–µ–ø–æ—á–∫–∏ –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã
    if ! check_chain_ipv6 "${1}" "${2}"; then
        exit 1
    fi

    # –°–ø–∏—Å–æ–∫ IPv6-–∞–¥—Ä–µ—Å–æ–≤ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ (—Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
    ipv6_list="
        ::/128                   # –ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –∞–¥—Ä–µ—Å (–∞–Ω–∞–ª–æ–≥ 0.0.0.0 –≤ IPv4)
        ::1/128                  # Loopback (–∞–Ω–∞–ª–æ–≥ 127.0.0.1)
        ::ffff:0:0/96            # IPv4-mapped –∞–¥—Ä–µ—Å–∞ (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π IPv4 –≤ IPv6)
        64:ff9b::/96             # IPv4-IPv6 —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è (NAT64)
        100::/64                 # Discard-–∞–¥—Ä–µ—Å–∞ (RFC 6666)
        2001::/32                # Teredo tunneling (—É—Å—Ç–∞—Ä–µ–≤—à–∏–π)
        2001:20::/28             # ORCHIDv2 (–∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã)
        2001:db8::/32            # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–æ–Ω–Ω—ã–µ –∞–¥—Ä–µ—Å–∞ (–∞–Ω–∞–ª–æ–≥ 192.0.2.0/24)
        2002::/16                # 6to4 tunneling (—É—Å—Ç–∞—Ä–µ–≤—à–∏–π)
        fc00::/7                 # –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∞–¥—Ä–µ—Å–∞ (ULA, –∞–Ω–∞–ª–æ–≥ IPv4 private)
        fe80::/10                # Link-local –∞–¥—Ä–µ—Å–∞ (–∞–Ω–∞–ª–æ–≥ 169.254.0.0/16)
        ff00::/8                 # Multicast (–∞–Ω–∞–ª–æ–≥ 224.0.0.0/4)
    "

    # –§–∏–ª—å—Ç—Ä: —É–¥–∞–ª—è–µ–º –≤—Å—ë, —á—Ç–æ –ø–æ—Å–ª–µ '#', –∑–∞—Ç–µ–º –æ–±—Ä–µ–∑–∞–µ–º –ø—Ä–æ–±–µ–ª—ã
    echo "$ipv6_list" | while read -r line; do
        # –£–¥–∞–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
        # sed -e 's/^[[:space:]]*//' –æ–±—Ä–µ–∑–∞–µ—Ç –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ,
        # sed -e 's/[[:space:]]*$//' ‚Äî –≤ –∫–æ–Ω—Ü–µ —Å—Ç—Ä–æ–∫–∏
        ip=$(echo "$line" | sed -e 's/#.*//' -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')
        [ -z "$ip" ] && continue  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏

        if [ "${2}" = "mangle" ] \
        && echo "$js_SETTING" | jq -e '.network.dns_filter // false' > /dev/null
        then
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø—Ä–∞–≤–∏–ª–æ —É–∂–µ
          if ! ip6tables -w -t "${2}" -C "${1}" -d "$ip" -p udp -m udp ! --dport 53  -j RETURN >/dev/null 2>&1; then
              ip6tables -w -t "${2}" -A "${1}" -d "$ip" -p udp -m udp ! --dport 53  -j RETURN >> "${LOG_FILE}" 2>&1
              debug "[OK] –î–æ–±–∞–≤–ª–µ–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ: $ip (—Ç–∞–±–ª–∏—Ü–∞: $2)"
          else
              debug "[–ü—Ä–æ–ø—É—Å–∫] –ü—Ä–∞–≤–∏–ª–æ –¥–ª—è $ip —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ $2"
          fi
        else
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø—Ä–∞–≤–∏–ª–æ —É–∂–µ
          if ! ip6tables -w -t "${2}" -C "${1}" -d "$ip" -j RETURN >/dev/null 2>&1; then
              ip6tables -w -t "${2}" -A "${1}" -d "$ip" -j RETURN >> "${LOG_FILE}" 2>&1
              debug "[OK] –î–æ–±–∞–≤–ª–µ–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ: $ip (—Ç–∞–±–ª–∏—Ü–∞: $2)"
          else
              debug "[–ü—Ä–æ–ø—É—Å–∫] –ü—Ä–∞–≤–∏–ª–æ –¥–ª—è $ip —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ $2"
          fi
        fi
    done
}

firewall_iptables_nat(){
  init_ip_rules 4
  init_tables_nat "iptables"
}

firewall_iptables_mangle(){
  init_ip_rules 4
  init_tables_mangle "iptables"
}

firewall_ip6tables_nat(){
  init_ip_rules 6
  init_tables_nat "ip6tables"
}

firewall_ip6tables_mangle(){
  init_ip_rules 6
  init_tables_mangle "ip6tables"
}

firewall_iptables(){
  firewall_iptables_nat
  firewall_iptables_mangle
}

firewall_ip6tables(){
  firewall_ip6tables_nat
  firewall_ip6tables_mangle
}

database_updates(){

  # –ü—Ä–æ–≤–µ—Ä–∫–∞, —Ä–∞–∑—Ä–µ—à–µ–Ω–∞ –ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞
  download=$(echo "$js_SETTING" | jq -r '.database.download // "false"')
  path_data=$(echo "$js_SETTING" | jq -r '.database.path_data // "/opt/etc/xray/dat"')
  # –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–∞—é—â–µ–≥–æ —Å–ª—ç—à–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å), –∑–∞—Ç–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ
  path_data="${path_data%/}/"

  if [ "$download" = "true" ]; then
    logger -t "$(basename "$0")" "–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∞. –ù–∞—á–∏–Ω–∞—é —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤..."

  # –ü–µ—Ä–µ–±–æ—Ä –∏ –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
    echo "$js_SETTING" | jq -r '.database.data | to_entries[] | "\(.key) \(.value)"' | while read -r filename url; do
      logger -t "$(basename "$0")" "–°–∫–∞—á–∏–≤–∞–Ω–∏–µ $filename –∏–∑ $url..."
      # curl -L -o "$path_data$filename" "$url" >> "${LOG_FILE}" 2>&1
      download_with_retry "${url}" "$path_data$filename"
    done
  else
    logger -t "$(basename "$0")" "–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞ (download = false)"
  fi
}

download_with_retry() {
  url="$1"
  filename="$2"
  temp_file="${filename}.tmp"
  max_retries=3
  attempt=1

  while [ $attempt -le $max_retries ]; do
    echo "üì• –ü–æ–ø—ã—Ç–∫–∞ $attempt: —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ $filename"

    if curl -sSL --fail -o "$temp_file" "$url"; then
      mv "$temp_file" "$filename"
      echo "‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω: $filename"
      logger -t "$(basename "$0")" "‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω: $filename"
      return 0
    else
      echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ $filename (–ø–æ–ø—ã—Ç–∫–∞ $attempt)"
      logger -t "$(basename "$0")" "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ $filename (–ø–æ–ø—ã—Ç–∫–∞ $attempt)"
      rm -f "$temp_file"  # –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω–æ–≥–æ –∏–ª–∏ –Ω–µ–ø–æ–ª–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    fi

    attempt=$((attempt + 1))
    sleep 1
  done

  echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å $filename –ø–æ—Å–ª–µ $max_retries –ø–æ–ø—ã—Ç–æ–∫"
  return 1
}

add_cron_from_json() {
  # –†–∞–∑–±–æ—Ä JSON
  MINUTE=$(echo "$js_SETTING" | jq -r '.database.time_update.minute // "15"' )
  HOUR=$(echo "$js_SETTING" | jq -r '.database.time_update.hour // "3"')
  DOM=$(echo "$js_SETTING" | jq -r '.database.time_update.day_of_month // "*"')
  MONTH=$(echo "$js_SETTING" | jq -r '.database.time_update.month // "*"')
  DOW=$(echo "$js_SETTING" | jq -r '.database.time_update.day_of_week // "*"')
  COMMAND=$(echo "$js_SETTING" | jq -r '.database.time_update.command // "/opt/etc/init.d/S98xray refresh"')
  DESCRIPTION=$(echo "$js_SETTING" | jq -r '.database.time_update.description // "Cron job from JSON"')

  CRON_LINE="$MINUTE $HOUR $DOM $MONTH $DOW $COMMAND"

  # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π crontab
  EXISTING=$(crontab -l 2>/dev/null || true)

  # –£–¥–∞–ª—è–µ–º –ª—é–±—ã–µ —Å—Ç—Ä–æ–∫–∏, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ –∫–æ–º–∞–Ω–¥—É (–≤–∫–ª—é—á–∞—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–µ—Ä–µ–¥ –Ω–µ–π)
  FILTERED=$(echo "$EXISTING" | awk -v cmd="$COMMAND" '
    BEGIN { skip=0 }
    $0 ~ "^#.*" && skip == 0 { desc=$0; next }
    index($0, cmd) > 0 { skip=1; next }
    skip == 1 { skip=0; next }
    { print }
  ')

  # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ
  echo "$FILTERED" | {
    cat
    echo "# $DESCRIPTION"
    echo "$CRON_LINE"
  } | crontab -

  echo "–û–±–Ω–æ–≤–ª–µ–Ω–æ cron-–∑–∞–¥–∞–Ω–∏–µ:"
  echo "$CRON_LINE"
  echo
  echo "–ê–∫—Ç—É–∞–ª—å–Ω—ã–π crontab:"
  crontab -l
}

remove_cron_job() {
  # –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–∞–Ω–¥—É –∏–∑ JSON –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  COMMAND=$(echo "$js_SETTING" | jq -r '.database.time_update.command // "/opt/etc/init.d/S98xray refresh"')

  # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π crontab
  EXISTING=$(crontab -l 2>/dev/null || true)

  # –£–¥–∞–ª—è–µ–º –∑–∞–¥–∞–Ω–∏–µ —Å —É–∫–∞–∑–∞–Ω–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–µ—Ä–µ–¥ –Ω–∏–º
  FILTERED=$(echo "$EXISTING" | awk -v cmd="$COMMAND" '
    BEGIN { skip=0; prev=""; }
    $0 ~ "^#.*" { prev=$0; next; }
    index($0, cmd) > 0 { skip=1; next; }
    { if (skip == 0) {
        if (prev != "") print prev;
        print;
      } else {
        skip=0;
      }
      prev="";
    }
  ')

  # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π crontab
  echo "$FILTERED" | crontab -

  echo "–£–¥–∞–ª–µ–Ω–æ cron-–∑–∞–¥–∞–Ω–∏–µ, —Å–æ–¥–µ—Ä–∂–∞—â–µ–µ –∫–æ–º–∞–Ω–¥—É: $COMMAND"
  echo
  echo "–ê–∫—Ç—É–∞–ª—å–Ω—ã–π crontab:"
  crontab -l
}

# –ú–µ–Ω–µ–¥–∂–µ—Ä –∫–æ–º–∞–Ω–¥
case $ACTION in
  start)
      if [ "$ENABLED" != yes ]; then
        name_client=$(echo "$js_SETTING" | jq -r '.client.name')
        echo -e " ${name_client} ${color_green}–û—Ç–∫–ª—é—á—ë–Ω –≤ —Ñ–∞–π–ª–µ \"$(basename "$0")\"${color_reset}"
		    return 1
	    fi
      if [ "$CALLER" = "cron" -a "$ENABLED" != yes ]; then
		    return 8
	    fi

      kernel_modules_load
      check_iptables_tproxy || exit 1
      check_iptables_multiport || exit 1
      wait_for_iptables_tables 20 || exit 1

      if is_running; then
        echo -e "$PROCS ${color_green} is already running ${color_reset}" >&2
        return 1
      fi

      policy_mark=$(get_policy_mark) || {
      policy=$(echo "$js_SETTING" | jq -r '.network.connection_policy')
      # shellcheck disable=SC3037
      echo -e "$(date '+%Y-%m-%d %H:%M:%S') ${color_yellow}[INFO]${color_reset} –î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª–∏—Ç–∏–∫—É ${policy} –Ω–∞ –≤–∞—à–µ–º —Ä–æ—É—Ç–µ—Ä–µ " >&2
      exit 1
      }
      name_client=$(echo "$js_SETTING" | jq -r '.client.name')
      echo -e " ${name_client} ${color_green}–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...${color_reset}"

      start_xray

      if [ -t 0 ]; then
        firewall_iptables
        [ "$IPv6" = "true" ] && firewall_ip6tables
        # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
        sleep 4
        if is_running; then
            echo -e " ${name_client} ${color_green}—É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω${color_reset}"
            logger -t "$(basename "$0")" "${name_client} —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω"
        else
            echo -e " ${name_client} ${color_red}–Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å${color_reset}"
            logger -t "$(basename "$0")" "${name_client} –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å"
            return 1
        fi
      else
        logger -t "$(basename "$0")" "${name_client} is set up for background launch via init/rc."
      fi
      ;;
  stop)
      del_ip_rules 4
      del_ip_rules 6
      chain_name=$(echo "$js_SETTING" | jq -r '.network.chain_name')
      chain_name_output="${chain_name}"_out
      del_iptables "${chain_name}"
      del_iptables "${chain_name_output}"
      stop_xray
      "$0" status
      ;;
  status)
      name_client=$(echo "$js_SETTING" | jq -r '.client.name')
      if is_running; then
        echo -e " ${name_client} ${color_green}–∑–∞–ø—É—â–µ–Ω${color_reset}"
      else
        echo -e " ${name_client} ${color_red}–æ—Ç–∫–ª—é—á—ë–Ω${color_reset}"
      fi
      ;;
  backup)
      backup_config_xray
    ;;
  restart)
      "$0" stop
      "$0" start
      ;;
  firewall_iptables_nat)
      if is_running; then
        firewall_iptables_nat
	    fi
      ;;
  firewall_iptables_mangle)
      if is_running; then
        firewall_iptables_mangle
      fi
      ;;
  firewall_ip6tables_nat)
      if is_running; then
        firewall_ip6tables_nat
      fi
      ;;
  firewall_ip6tables_mangle)
      if is_running; then
        firewall_ip6tables_mangle
      fi
      ;;
  database_up)
      database_updates
      ;;
  refresh)
      logger -t "$(basename "$0")" "Refresh has been started"
      database_updates
      logger -t "$(basename "$0")" "The database updates have been applied"
      "$0" stop
      "$0" start
      if ! [ -t 0 ]; then
        "$0" firewall_up
      fi
      ;;
  fast_restart)
      stop_xray
      "$0" status
      start_xray
      "$0" status
      ;;
  cron)
    case "$2" in
        add)
            add_cron_from_json
            ;;
        del)
            remove_cron_job
            ;;
        *)
            echo -e "  –ö–æ–º–∞–Ω–¥—ã: ${color_green}cron add ${color_reset} | ${color_yellow}cron del${color_reset} "
            ;;
    esac
    ;;
  firewall_up)
      firewall_iptables
      [ "$IPv6" = "true" ] && firewall_ip6tables
      logger -t "$(basename "$0")" "Firewall was launched"
      ;;
  firewall_down)
      del_ip_rules 4
      del_ip_rules 6
      chain_name=$(echo "$js_SETTING" | jq -r '.network.chain_name')
      chain_name_output="${chain_name}"_out
      del_iptables "${chain_name}"
      del_iptables "${chain_name_output}"
      ;;
  *)
      echo -e "  –ö–æ–º–∞–Ω–¥—ã: ${color_green}start${color_reset} | ${color_red}stop${color_reset} | ${color_yellow}restart${color_reset} | ${color_blue}backup${color_reset} | ${color_green}cron${color_reset} | status"
      ;;
esac

exit 0
